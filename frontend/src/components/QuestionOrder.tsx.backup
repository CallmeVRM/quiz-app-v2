// src/components/QuestionOrder.tsx
import { useState } from "react";

type QuestionOrderProps = {
  question: {
    id: string;
    prompt: string;
    items: string[];
  };
  answer: number[] | undefined;
  onAnswerChange: (answer: number[]) => void;
  checked?: { correctAnswer: number[]; isCorrect: boolean } | null;
};

export default function QuestionOrder({
  question,
  answer,
  onAnswerChange,
  checked,
}: QuestionOrderProps) {
  const [draggedFrom, setDraggedFrom] = useState<{ source: "left" | "right"; index: number } | null>(null);

  // Liste de r√©ponses s√©lectionn√©es dans l'ordre (indices des items)
  const selectedOrder = answer || [];
  
  // Items restants √† gauche (non s√©lectionn√©s)
  const availableItems = question.items
    .map((item, idx) => ({ item, originalIndex: idx }))
    .filter(({ originalIndex }) => !selectedOrder.includes(originalIndex));

  const handleDragStart = (index: number) => {
    if (checked) return; // D√©sactiver en mode correction
    setDraggedIndex(index);
  };

  const handleDragOver = (e: React.DragEvent) => {
    e.preventDefault();
  };

  const handleDrop = (targetIndex: number) => {
    if (draggedIndex === null || checked) return;

    const newOrder = [...currentOrder];
    const [removed] = newOrder.splice(draggedIndex, 1);
    newOrder.splice(targetIndex, 0, removed);

    onAnswerChange(newOrder);
    setDraggedIndex(null);
  };

  const handleMoveUp = (index: number) => {
    if (index === 0 || checked) return;
    const newOrder = [...currentOrder];
    [newOrder[index - 1], newOrder[index]] = [newOrder[index], newOrder[index - 1]];
    onAnswerChange(newOrder);
  };

  const handleMoveDown = (index: number) => {
    if (index === currentOrder.length - 1 || checked) return;
    const newOrder = [...currentOrder];
    [newOrder[index], newOrder[index + 1]] = [newOrder[index + 1], newOrder[index]];
    onAnswerChange(newOrder);
  };

  const getItemClass = (index: number): string => {
    const base = "p-4 rounded-lg border-2 bg-white transition-all flex items-center gap-3";
    
    if (!checked) {
      return `${base} border-gray-300 cursor-move hover:border-blue-400 hover:shadow-md`;
    }

    // Mode correction
    const isInCorrectPosition = checked.correctAnswer[index] === currentOrder[index];
    return `${base} ${
      isInCorrectPosition ? "border-green-500 bg-green-50" : "border-red-500 bg-red-50"
    }`;
  };

  return (
    <div className="space-y-4">
      <h3 className="text-xl font-semibold mb-4">{question.prompt}</h3>
      
      {!checked && (
        <p className="text-sm text-gray-600 mb-4">
          üñ±Ô∏è Glissez-d√©posez les √©l√©ments ou utilisez les fl√®ches pour les r√©organiser dans le bon ordre.
        </p>
      )}

      <div className="space-y-2">
        {currentOrder.map((originalIndex, displayIndex) => (
          <div
            key={displayIndex}
            draggable={!checked}
            onDragStart={() => handleDragStart(displayIndex)}
            onDragOver={handleDragOver}
            onDrop={() => handleDrop(displayIndex)}
            className={getItemClass(displayIndex)}
          >
            <span className="text-lg font-bold text-gray-400 w-8">
              {displayIndex + 1}.
            </span>
            <span className="flex-1">{question.items[originalIndex]}</span>
            
            {!checked && (
              <div className="flex gap-1">
                <button
                  onClick={() => handleMoveUp(displayIndex)}
                  disabled={displayIndex === 0}
                  className="px-2 py-1 text-sm bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-30 disabled:cursor-not-allowed"
                  aria-label="Move up"
                >
                  ‚ñ≤
                </button>
                <button
                  onClick={() => handleMoveDown(displayIndex)}
                  disabled={displayIndex === currentOrder.length - 1}
                  className="px-2 py-1 text-sm bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-30 disabled:cursor-not-allowed"
                  aria-label="Move down"
                >
                  ‚ñº
                </button>
              </div>
            )}

            {checked && (
              <span className="text-lg">
                {checked.correctAnswer[displayIndex] === currentOrder[displayIndex] ? "‚úì" : "‚úó"}
              </span>
            )}
          </div>
        ))}
      </div>

      {checked && !checked.isCorrect && (
        <div className="mt-4 p-4 bg-blue-50 border border-blue-200 rounded">
          <p className="font-semibold mb-2">Ordre correct :</p>
          <ol className="list-decimal list-inside space-y-1">
            {checked.correctAnswer.map((idx) => (
              <li key={idx}>{question.items[idx]}</li>
            ))}
          </ol>
        </div>
      )}
    </div>
  );
}
